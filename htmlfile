<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flood Evacuation Planner (Global)</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { width: 100%; height: 600px; }
    .pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.5;} }
    .btn-active { outline: 3px solid rgba(37,99,235,0.35); }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-blue-100">
<div class="container mx-auto p-4 max-w-7xl">

  <!-- Header -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">âš ï¸</div>
        <h1 id="pageTitle" class="text-2xl font-bold text-gray-800">Sel Tahliye Planlama (Global)</h1>
      </div>

      <div class="flex items-center gap-3 flex-wrap">
        <div class="flex gap-2 flex-wrap text-sm">
          <span class="bg-blue-50 px-3 py-1 rounded-full"><b class="text-blue-700">â—</b> <span id="legendLoc">Konum</span></span>
          <span class="bg-red-50 px-3 py-1 rounded-full"><b class="text-red-700">â—</b> <span id="legendFlood">Sel NoktasÄ±</span></span>
          <span class="bg-green-50 px-3 py-1 rounded-full"><b class="text-green-700">â—</b> <span id="legendSafe">GÃ¼venli BÃ¶lge</span></span>
          <span class="bg-amber-50 px-3 py-1 rounded-full"><b class="text-amber-700">â–²</b> <span id="legendEvac">Tahliye NoktasÄ±</span></span>
        </div>

        <div class="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-lg">
          <span class="text-xs text-gray-600 font-semibold" id="langLabel">Dil</span>
          <select id="langSelect" class="text-sm bg-white border border-gray-300 rounded-md px-2 py-1">
            <option value="tr" selected>TR</option>
            <option value="en">EN</option>
          </select>
        </div>
      </div>
    </div>

    <div class="mt-3 text-sm text-gray-600" id="subtitle">
      Haritaya tÄ±klayarak konum ve sel noktalarÄ±nÄ± seÃ§ebilirsiniz (her yer).
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left panel -->
    <div class="lg:col-span-1 space-y-4">

      <!-- Selection controls -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 id="panelPickTitle" class="text-lg font-bold mb-3">Haritadan SeÃ§im</h2>

        <div class="grid grid-cols-1 gap-2">
          <button id="modeLocationBtn"
            class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
            ğŸ“ <span id="btnPickLocation">Konumu Haritadan SeÃ§</span>
          </button>

          <button id="modeFloodBtn"
            class="w-full bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition">
            âš ï¸ <span id="btnAddFlood">Sel NoktasÄ± Ekle (Haritadan)</span>
          </button>

          <button id="clearFloodBtn"
            class="w-full bg-gray-100 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-200 transition">
            ğŸ§¹ <span id="btnClearFlood">Sel NoktalarÄ±nÄ± Temizle</span>
          </button>

          <button id="resetAllBtn"
            class="w-full bg-gray-900 text-white py-3 rounded-lg font-semibold hover:bg-black transition">
            ğŸ”„ <span id="btnResetAll">Her Åeyi SÄ±fÄ±rla</span>
          </button>
        </div>

        <div class="mt-3 p-3 bg-blue-50 rounded-lg text-sm">
          <div class="font-semibold text-blue-900 mb-1" id="modeLabel">SeÃ§ili Mod:</div>
          <div id="modeText" class="text-blue-700">-</div>
        </div>

        <div id="locationInfo" class="mt-3 p-3 bg-blue-50 rounded-lg text-sm hidden">
          <p class="text-blue-700" id="locationText">ğŸ“ Konum bekleniyor...</p>
        </div>
      </div>

      <!-- Find safe -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 id="panelSafeTitle" class="text-lg font-bold mb-2">GÃ¼venli Alan & Rota</h2>

        <button id="findSafeBtn" disabled
          class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
          ğŸ” <span id="btnFindSafe">GÃ¼venli BÃ¶lgeleri Bul</span>
        </button>

        <div class="mt-3 text-xs text-gray-600">
          <b id="noteBold">Not:</b> <span id="noteText">GÃ¼venli alanlar OSMâ€™den (park/okul/hastane/stadyum) alÄ±nÄ±r.</span>
        </div>

        <div id="resultsPanel" class="mt-4 hidden">
          <h3 class="font-bold mb-2 text-green-800" id="safeListTitle">GÃ¼venli BÃ¶lgeler</h3>
          <div id="safeZonesList" class="space-y-2 mb-4"></div>

          <h3 class="font-bold mb-2 text-amber-800" id="evacListTitle">Tahliye NoktalarÄ±</h3>
          <div id="evacuationPointsList" class="space-y-2 mb-4"></div>

          <button id="createRouteBtn"
            class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition">
            ğŸ—ºï¸ <span id="btnRoute">En YakÄ±n GÃ¼venli RotayÄ± GÃ¶ster</span>
          </button>
        </div>

        <div id="routePanel" class="mt-4 hidden">
          <h3 class="font-bold mb-2" id="routeInfoTitle">Rota Bilgileri</h3>
          <div class="space-y-2">
            <div class="p-3 bg-blue-50 rounded-lg">
              <div class="text-sm text-blue-600" id="distanceLabel">Mesafe</div>
              <div class="text-2xl font-bold text-blue-900" id="routeDistance">-</div>
            </div>
            <div class="p-3 bg-green-50 rounded-lg">
              <div class="text-sm text-green-600" id="durationLabel">Tahmini SÃ¼re</div>
              <div class="text-2xl font-bold text-green-900" id="routeDuration">-</div>
            </div>
            <div class="p-3 bg-purple-50 rounded-lg">
              <div class="text-sm text-purple-600" id="destLabel">Hedef</div>
              <div class="text-lg font-bold text-purple-900" id="routeDestination">-</div>
            </div>
          </div>

          <div class="mt-3 p-3 bg-amber-50 border-l-4 border-amber-500 rounded text-sm text-amber-800">
            <b id="warnBold">Ã–nemli:</b> <span id="warnText">Ana yollarÄ± tercih edin, alt geÃ§it/dere yataklarÄ±ndan kaÃ§Ä±nÄ±n.</span>
          </div>
        </div>

      </div>
    </div>

    <!-- Map -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div id="map"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===========================
  // i18n
  // ===========================
  const I18N = {
    tr: {
      pageTitle: "Sel Tahliye Planlama (Global)",
      subtitle: "Haritaya tÄ±klayarak konum ve sel noktalarÄ±nÄ± seÃ§ebilirsiniz (her yer).",
      legendLoc: "Konum",
      legendFlood: "Sel NoktasÄ±",
      legendSafe: "GÃ¼venli BÃ¶lge",
      legendEvac: "Tahliye NoktasÄ±",
      langLabel: "Dil",

      panelPickTitle: "Haritadan SeÃ§im",
      btnPickLocation: "Konumu Haritadan SeÃ§",
      btnAddFlood: "Sel NoktasÄ± Ekle (Haritadan)",
      btnClearFlood: "Sel NoktalarÄ±nÄ± Temizle",
      btnResetAll: "Her Åeyi SÄ±fÄ±rla",
      modeLabel: "SeÃ§ili Mod:",

      locWaiting: "ğŸ“ Konum bekleniyor...",

      panelSafeTitle: "GÃ¼venli Alan & Rota",
      btnFindSafe: "GÃ¼venli BÃ¶lgeleri Bul",
      noteBold: "Not:",
      noteText: "GÃ¼venli alanlar OSMâ€™den (park/okul/hastane/stadyum) alÄ±nÄ±r.",

      safeListTitle: "GÃ¼venli BÃ¶lgeler",
      evacListTitle: "Tahliye NoktalarÄ±",
      btnRoute: "En YakÄ±n GÃ¼venli RotayÄ± GÃ¶ster",

      routeInfoTitle: "Rota Bilgileri",
      distanceLabel: "Mesafe",
      durationLabel: "Tahmini SÃ¼re",
      destLabel: "Hedef",

      warnBold: "Ã–nemli:",
      warnText: "Ana yollarÄ± tercih edin, alt geÃ§it/dere yataklarÄ±ndan kaÃ§Ä±nÄ±n.",

      modeNone: "-",
      modeLocation: "ğŸ“ Konum seÃ§me (haritaya tÄ±kla)",
      modeFlood: "âš ï¸ Sel noktasÄ± ekleme (haritaya tÄ±kla)",

      alerts: {
        pickLocation: "Ã–nce haritadan konum seÃ§!",
        addFlood: "En az 1 sel noktasÄ± ekle!",
        poiFail: "POI Ã§ekilemedi (Overpass yoÄŸun olabilir). Tekrar dene.",
        noTarget: "Uygun hedef yok.",
        routeFail: "Rota alÄ±namadÄ±."
      },
      labels: {
        locationPopup: "Konum",
        floodPopup: "Sel noktasÄ±",
        safePopup: "GÃ¼venli",
        evacPopup: "Tahliye"
      }
    },
    en: {
      pageTitle: "Flood Evacuation Planner (Global)",
      subtitle: "You can select your location and flood points by clicking on the map (anywhere).",
      legendLoc: "Location",
      legendFlood: "Flood Point",
      legendSafe: "Safe Zone",
      legendEvac: "Evacuation Point",
      langLabel: "Language",

      panelPickTitle: "Pick from Map",
      btnPickLocation: "Pick Location on Map",
      btnAddFlood: "Add Flood Point (on Map)",
      btnClearFlood: "Clear Flood Points",
      btnResetAll: "Reset Everything",
      modeLabel: "Selected Mode:",

      locWaiting: "ğŸ“ Waiting for location...",

      panelSafeTitle: "Safe Areas & Route",
      btnFindSafe: "Find Safe Areas",
      noteBold: "Note:",
      noteText: "Safe areas are fetched from OSM (park/school/hospital/stadium).",

      safeListTitle: "Safe Zones",
      evacListTitle: "Evacuation Points",
      btnRoute: "Show Nearest Safe Route",

      routeInfoTitle: "Route Info",
      distanceLabel: "Distance",
      durationLabel: "Estimated Time",
      destLabel: "Destination",

      warnBold: "Important:",
      warnText: "Prefer main roads; avoid underpasses/streambeds with water accumulation.",

      modeNone: "-",
      modeLocation: "ğŸ“ Pick location (click on map)",
      modeFlood: "âš ï¸ Add flood point (click on map)",

      alerts: {
        pickLocation: "Please pick a location on the map first!",
        addFlood: "Add at least one flood point!",
        poiFail: "Could not fetch POIs (Overpass may be busy). Please try again.",
        noTarget: "No suitable target found.",
        routeFail: "Could not fetch the route."
      },
      labels: {
        locationPopup: "Location",
        floodPopup: "Flood point",
        safePopup: "Safe",
        evacPopup: "Evacuation"
      }
    }
  };

  let lang = "tr";
  function tr(key) {
    const parts = key.split(".");
    let cur = I18N[lang];
    for (const p of parts) cur = cur?.[p];
    return cur ?? key;
  }

  function applyLanguage() {
    document.documentElement.lang = lang;

    document.getElementById("pageTitle").textContent = tr("pageTitle");
    document.getElementById("subtitle").textContent = tr("subtitle");
    document.getElementById("legendLoc").textContent = tr("legendLoc");
    document.getElementById("legendFlood").textContent = tr("legendFlood");
    document.getElementById("legendSafe").textContent = tr("legendSafe");
    document.getElementById("legendEvac").textContent = tr("legendEvac");
    document.getElementById("langLabel").textContent = tr("langLabel");

    document.getElementById("panelPickTitle").textContent = tr("panelPickTitle");
    document.getElementById("btnPickLocation").textContent = tr("btnPickLocation");
    document.getElementById("btnAddFlood").textContent = tr("btnAddFlood");
    document.getElementById("btnClearFlood").textContent = tr("btnClearFlood");
    document.getElementById("btnResetAll").textContent = tr("btnResetAll");
    document.getElementById("modeLabel").textContent = tr("modeLabel");

    if (!currentLocation) {
      document.getElementById("locationText").textContent = tr("locWaiting");
    }

    document.getElementById("panelSafeTitle").textContent = tr("panelSafeTitle");
    document.getElementById("btnFindSafe").textContent = tr("btnFindSafe");
    document.getElementById("noteBold").textContent = tr("noteBold");
    document.getElementById("noteText").textContent = tr("noteText");

    document.getElementById("safeListTitle").textContent = tr("safeListTitle");
    document.getElementById("evacListTitle").textContent = tr("evacListTitle");
    document.getElementById("btnRoute").textContent = tr("btnRoute");

    document.getElementById("routeInfoTitle").textContent = tr("routeInfoTitle");
    document.getElementById("distanceLabel").textContent = tr("distanceLabel");
    document.getElementById("durationLabel").textContent = tr("durationLabel");
    document.getElementById("destLabel").textContent = tr("destLabel");

    document.getElementById("warnBold").textContent = tr("warnBold");
    document.getElementById("warnText").textContent = tr("warnText");

    // update mode text
    const modeText = document.getElementById("modeText");
    if (mode === "location") modeText.textContent = tr("modeLocation");
    else if (mode === "flood") modeText.textContent = tr("modeFlood");
    else modeText.textContent = tr("modeNone");
  }

  document.getElementById("langSelect").addEventListener("change", (e) => {
    lang = e.target.value;
    applyLanguage();
  });

  // ===========================
  // Utils
  // ===========================
  const fmtKm = (m) => (m/1000).toFixed(2) + " km";
  const fmtMin = (s) => {
    const mins = Math.round(s/60);
    return lang === "tr" ? `${mins} dk` : `${mins} min`;
  };

  function distanceMeters(a, b) {
    const R = 6371000;
    const toRad = (x) => x * Math.PI / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);
    const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
    return 2 * R * Math.asin(Math.sqrt(h));
  }

  // ===========================
  // Overpass POIs
  // ===========================
  async function overpassPOIs(center, radiusM) {
    const query = `
      [out:json][timeout:25];
      (
        node["leisure"="park"](around:${radiusM},${center.lat},${center.lng});
        node["amenity"="school"](around:${radiusM},${center.lat},${center.lng});
        node["amenity"="hospital"](around:${radiusM},${center.lat},${center.lng});
        node["leisure"="stadium"](around:${radiusM},${center.lat},${center.lng});
        way["leisure"="park"](around:${radiusM},${center.lat},${center.lng});
        way["amenity"="school"](around:${radiusM},${center.lat},${center.lng});
        way["amenity"="hospital"](around:${radiusM},${center.lat},${center.lng});
        way["leisure"="stadium"](around:${radiusM},${center.lat},${center.lng});
      );
      out center tags;
    `.trim();

    const res = await fetch("https://overpass-api.de/api/interpreter", {
      method: "POST",
      body: query,
      headers: { "Content-Type": "text/plain" }
    });
    const json = await res.json();

    return (json.elements || []).map(el => {
      const lat = el.type === "node" ? el.lat : el.center?.lat;
      const lng = el.type === "node" ? el.lon : el.center?.lon;
      const name = el.tags?.name || (lang === "tr" ? "(Ä°simsiz)" : "(Unnamed)");
      const type =
        el.tags?.amenity === "school" ? "school" :
        el.tags?.amenity === "hospital" ? "hospital" :
        el.tags?.leisure === "stadium" ? "stadium" :
        el.tags?.leisure === "park" ? "park" : "other";
      if (lat == null || lng == null) return null;
      return { name, type, lat, lng };
    }).filter(Boolean);
  }

  // ===========================
  // OSRM routing
  // ===========================
  async function osrmRouteWalking(from, to) {
    const url = `https://router.project-osrm.org/route/v1/walking/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
    const res = await fetch(url);
    const json = await res.json();
    if (!json.routes || !json.routes[0]) return null;
    const r = json.routes[0];
    return { distance: r.distance, duration: r.duration, geojson: r.geometry };
  }

  // ===========================
  // Map / State
  // ===========================
  let map;

  let mode = "none"; // "location" | "flood"
  let currentLocation = null;
  let userMarker = null;

  const floodZones = []; // {lat,lng}
  const floodCircles = [];

  let safeZones = [];
  let evacPoints = [];
  const poiMarkers = [];
  let routeLayer = null;

  function setMode(newMode) {
    mode = newMode;
    applyLanguage(); // updates mode text + other strings

    document.getElementById("modeLocationBtn").classList.toggle("btn-active", mode === "location");
    document.getElementById("modeFloodBtn").classList.toggle("btn-active", mode === "flood");
  }

  function clearPOIsAndRoute() {
    poiMarkers.forEach(m => m.remove());
    poiMarkers.length = 0;
    if (routeLayer) routeLayer.remove();
    routeLayer = null;
    document.getElementById("routePanel").classList.add("hidden");
  }

  function initMap() {
    map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // optional: zoom to browser location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        map.setView([pos.coords.latitude, pos.coords.longitude], 12);
      });
    }

    map.on("click", (e) => {
      const point = { lat: e.latlng.lat, lng: e.latlng.lng };
      if (mode === "location") setLocation(point);
      else if (mode === "flood") addFloodPoint(point);
    });
  }

  function setLocation(point) {
    currentLocation = point;

    if (userMarker) userMarker.remove();
    userMarker = L.circleMarker([point.lat, point.lng], {
      radius: 10, weight: 3, color: "white", fillColor: "#2563eb", fillOpacity: 1
    }).addTo(map).bindPopup(tr("labels.locationPopup")).openPopup();

    document.getElementById('locationInfo').classList.remove('hidden');
    document.getElementById('locationText').innerHTML =
      `ğŸ“ Lat: ${point.lat.toFixed(6)}<br>ğŸ“ Lng: ${point.lng.toFixed(6)}`;

    document.getElementById("findSafeBtn").disabled = floodZones.length === 0;
    clearPOIsAndRoute();
    document.getElementById("resultsPanel").classList.add("hidden");
  }

  function addFloodPoint(point) {
    floodZones.push(point);

    const circle = L.circle([point.lat, point.lng], {
      radius: 700,
      color: "#ff0000",
      weight: 2,
      fillColor: "#ff0000",
      fillOpacity: 0.20
    }).addTo(map).bindPopup(tr("labels.floodPopup"));
    floodCircles.push(circle);

    document.getElementById("findSafeBtn").disabled = !currentLocation;
    clearPOIsAndRoute();
    document.getElementById("resultsPanel").classList.add("hidden");
  }

  function clearFlood() {
    floodZones.length = 0;
    floodCircles.forEach(c => c.remove());
    floodCircles.length = 0;
    document.getElementById("findSafeBtn").disabled = true;
    clearPOIsAndRoute();
    document.getElementById("resultsPanel").classList.add("hidden");
  }

  function resetAll() {
    clearFlood();
    if (userMarker) userMarker.remove();
    userMarker = null;
    currentLocation = null;
    document.getElementById('locationInfo').classList.add('hidden');
    setMode("none");
  }

  initMap();
  setMode("none");
  applyLanguage();

  // ===========================
  // UI buttons
  // ===========================
  document.getElementById("modeLocationBtn").addEventListener("click", () => setMode("location"));
  document.getElementById("modeFloodBtn").addEventListener("click", () => setMode("flood"));
  document.getElementById("clearFloodBtn").addEventListener("click", clearFlood);
  document.getElementById("resetAllBtn").addEventListener("click", resetAll);

  // ===========================
  // Safe zones + route
  // ===========================
  document.getElementById("findSafeBtn").addEventListener("click", findSafeZones);

  async function findSafeZones() {
    if (!currentLocation) return alert(tr("alerts.pickLocation"));
    if (floodZones.length === 0) return alert(tr("alerts.addFlood"));

    const btn = document.getElementById("findSafeBtn");
    btn.disabled = true;
    btn.innerHTML = `<span class="pulse">ğŸ” ${lang === "tr" ? "AranÄ±yor..." : "Searching..."}</span>`;

    clearPOIsAndRoute();
    safeZones = [];
    evacPoints = [];

    let pois = [];
    try {
      pois = await overpassPOIs(currentLocation, 5000);
    } catch (e) {
      console.error(e);
      alert(tr("alerts.poiFail"));
      btn.disabled = false;
      btn.innerHTML = `ğŸ” <span id="btnFindSafe">${tr("btnFindSafe")}</span>`;
      return;
    }

    const MIN_DIST_FROM_FLOOD = 1000;

    const filtered = pois.map(p => {
      const pnt = { lat: p.lat, lng: p.lng };
      const dUser = distanceMeters(currentLocation, pnt);
      const safe = floodZones.every(f => distanceMeters(pnt, f) > MIN_DIST_FROM_FLOOD);
      return { ...p, distance: dUser, safe };
    }).filter(x => x.safe);

    for (const p of filtered) {
      if (p.type === "park" || p.type === "stadium") evacPoints.push(p);
      else if (p.type === "school" || p.type === "hospital") safeZones.push(p);
    }

    safeZones.sort((a,b)=>a.distance-b.distance);
    evacPoints.sort((a,b)=>a.distance-b.distance);

    safeZones = safeZones.slice(0,4);
    evacPoints = evacPoints.slice(0,4);

    // Map markers
    safeZones.forEach(z => {
      const m = L.circleMarker([z.lat, z.lng], {
        radius: 8, weight: 2, color: "white", fillColor: "#10b981", fillOpacity: 1
      }).addTo(map).bindPopup(`${tr("labels.safePopup")}: ${z.name}<br>${fmtKm(z.distance)}`);
      poiMarkers.push(m);
    });

    evacPoints.forEach(z => {
      const m = L.marker([z.lat, z.lng], {
        icon: L.divIcon({
          className: "",
          html: `<div style="transform: translate(-50%,-50%); font-size:18px;">â–²</div>`,
          iconSize: [20,20]
        })
      }).addTo(map).bindPopup(`${tr("labels.evacPopup")}: ${z.name}<br>${fmtKm(z.distance)}`);
      poiMarkers.push(m);
    });

    // Lists
    const safeList = document.getElementById("safeZonesList");
    safeList.innerHTML = "";
    safeZones.forEach(z => {
      const div = document.createElement("div");
      div.className = "p-3 bg-green-50 rounded-lg";
      div.innerHTML = `<b class="text-green-900">${z.name}</b><div class="text-sm text-green-700">ğŸ“ ${fmtKm(z.distance)}</div>`;
      safeList.appendChild(div);
    });

    const evacList = document.getElementById("evacuationPointsList");
    evacList.innerHTML = "";
    evacPoints.forEach(z => {
      const div = document.createElement("div");
      div.className = "p-3 bg-amber-50 rounded-lg";
      div.innerHTML = `<b class="text-amber-900">${z.name}</b><div class="text-sm text-amber-700">ğŸ“ ${fmtKm(z.distance)}</div>`;
      evacList.appendChild(div);
    });

    document.getElementById("resultsPanel").classList.remove("hidden");

    btn.innerHTML = `âœ“ ${lang === "tr" ? "Bulundu" : "Found"}`;
    btn.classList.remove("bg-green-500","hover:bg-green-600");
    btn.classList.add("bg-gray-400");
  }

  document.getElementById("createRouteBtn").addEventListener("click", async () => {
    if (!currentLocation) return;
    const target = safeZones[0] || evacPoints[0];
    if (!target) return alert(tr("alerts.noTarget"));

    const btn = document.getElementById("createRouteBtn");
    btn.disabled = true;
    btn.innerHTML = `<span class="pulse">ğŸš¶ ${lang === "tr" ? "Rota hesaplanÄ±yor..." : "Calculating route..."}</span>`;

    if (routeLayer) routeLayer.remove();
    routeLayer = null;

    const route = await osrmRouteWalking(currentLocation, { lat: target.lat, lng: target.lng });
    if (!route) {
      alert(tr("alerts.routeFail"));
      btn.disabled = false;
      btn.innerHTML = `ğŸ—ºï¸ <span id="btnRoute">${tr("btnRoute")}</span>`;
      return;
    }

    routeLayer = L.geoJSON(route.geojson, { weight: 5 }).addTo(map);
    map.fitBounds(routeLayer.getBounds(), { padding: [30,30] });

    document.getElementById("routePanel").classList.remove("hidden");
    document.getElementById("routeDistance").textContent = fmtKm(route.distance);
    document.getElementById("routeDuration").textContent = fmtMin(route.duration);
    document.getElementById("routeDestination").textContent = target.name;

    btn.disabled = false;
    btn.innerHTML = `ğŸ—ºï¸ <span id="btnRoute">${tr("btnRoute")}</span>`;
  });
</script>

<!-- PWA SW -->
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
  }
</script>

</body>
</html>
